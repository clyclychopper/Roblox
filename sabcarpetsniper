local Players = game:GetService("Players")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

local FIRE_DISTANCE = 5
local DEBOUNCE = 3
local REFIRE_COOLDOWN = 12
local lastFired = 0
local isBusy = false

local renderedFolder = workspace:WaitForChild("RenderedMovingAnimals")
local recentlyFired = {}

-- ANTI AFK (PC + Delta Mobile)
spawn(function()
    while true do
        wait(60)
        pcall(function()
            player:Move(Vector3.new(0, 0, 0), true)
        end)
        pcall(function()
            local cam = workspace.CurrentCamera
            local cf = cam.CFrame
            cam.CFrame = cf * CFrame.Angles(0, math.rad(0.001), 0)
            wait(0.1)
            cam.CFrame = cf
        end)
    end
end)

player.Idled:Connect(function()
    pcall(function() player:Move(Vector3.new(0, 0, 0), true) end)
    pcall(function()
        local cam = workspace.CurrentCamera
        local cf = cam.CFrame
        cam.CFrame = cf * CFrame.Angles(0, math.rad(0.001), 0)
        wait(0.1)
        cam.CFrame = cf
    end)
end)

local function cleanRecentlyFired()
    local now = tick()
    for prompt, firedAt in pairs(recentlyFired) do
        if now - firedAt > REFIRE_COOLDOWN then
            print("[AutoBuyer] Cleared cooldown for prompt:", prompt)
            recentlyFired[prompt] = nil
        end
    end
end

local function matchesTarget(objectText)
    for _, name in ipairs(getgenv().targetNames) do
        if objectText:lower():find(name:lower(), 1, true) then
            return true, name
        end
    end
    return false, nil
end

local function getPromptPart(prompt)
    local p = prompt.Parent
    if p:IsA("Attachment") then p = p.Parent end
    if p:IsA("BasePart") then return p end
    return nil
end

local function isAnimalRendered(targetName)
    for _, child in ipairs(renderedFolder:GetChildren()) do
        if child.Name:lower():find(targetName:lower(), 1, true) then
            return true
        end
    end
    return false
end

local function findClosestPrompt()
    cleanRecentlyFired()

    local closestPrompt = nil
    local closestPart = nil
    local closestDist = math.huge
    local closestMatchedName = nil

    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") and obj.ActionText == "Purchase" then
            local matches, matchedName = matchesTarget(obj.ObjectText)
            if matches and isAnimalRendered(matchedName) then
                if not recentlyFired[obj] then
                    local part = getPromptPart(obj)
                    if part then
                        local dist = (rootPart.Position - part.Position).Magnitude
                        if dist < closestDist then
                            closestDist = dist
                            closestPrompt = obj
                            closestPart = part
                            closestMatchedName = matchedName
                        end
                    end
                else
                    print("[AutoBuyer] Skipping prompt (on cooldown):", obj.ObjectText)
                end
            end
        end
    end

    if closestPrompt then
        print(string.format("[AutoBuyer] Found target: '%s' | Dist: %.2f", closestMatchedName, closestDist))
    else
        print("[AutoBuyer] No valid targets found.")
    end

    return closestPrompt, closestPart, closestDist, closestMatchedName
end

local function findAndFire()
    if isBusy then
        print("[AutoBuyer] Busy, skipping cycle.")
        return
    end
    local now = tick()
    if now - lastFired < DEBOUNCE then
        print(string.format("[AutoBuyer] Debounce active. %.2fs remaining.", DEBOUNCE - (now - lastFired)))
        return
    end

    local prompt, part, dist, matchedName = findClosestPrompt()
    if not prompt or not part then
        print("[AutoBuyer] Nothing to do this cycle.")
        return
    end

    isBusy = true
    print(string.format("[AutoBuyer] Locking onto: '%s' | Starting dist: %.2f", matchedName, dist))

    -- FIX: Mark as recently fired IMMEDIATELY when we lock on, not after firing
    -- This prevents re-selecting the same target if isBusy resets mid-loop
    recentlyFired[prompt] = tick()

    local lockedPrompt = prompt
    local lockedPart = part
    local lockedName = matchedName
    local fired = false
    local timeout = tick() + 15

    while tick() < timeout do
        if not lockedPrompt or not lockedPrompt.Parent or not lockedPart or not lockedPart.Parent then
            print("[AutoBuyer] Locked prompt/part destroyed, aborting.")
            break
        end

        if not isAnimalRendered(lockedName) then
            print("[AutoBuyer] Animal '" .. lockedName .. "' no longer rendered, aborting.")
            -- FIX: Remove from recentlyFired so it can be retried if it reappears
            recentlyFired[lockedPrompt] = nil
            break
        end

        local currentDist = (rootPart.Position - lockedPart.Position).Magnitude
        print(string.format("[AutoBuyer] Moving to '%s' | Dist: %.2f", lockedName, currentDist))
        humanoid:MoveTo(lockedPart.Position)

        if currentDist <= FIRE_DISTANCE then
            task.wait(0.15)
            if lockedPrompt and lockedPrompt.Parent then
                local finalDist = (rootPart.Position - lockedPart.Position).Magnitude
                if finalDist <= FIRE_DISTANCE then
                    print("[AutoBuyer] Firing prompt for: " .. lockedName)
                    fireproximityprompt(lockedPrompt)
                    lastFired = tick()
                    -- Update the fired time (was pre-set above, now confirm with real fire time)
                    recentlyFired[lockedPrompt] = tick()
                    fired = true
                    print("[AutoBuyer] Successfully fired! Cooldown started for: " .. lockedName)
                else
                    print(string.format("[AutoBuyer] Too far after wait: %.2f, retrying...", finalDist))
                end
            end
            break
        end

        task.wait(0.1)
    end

    if not fired then
        print("[AutoBuyer] Did not fire for: " .. lockedName .. " (timeout or aborted)")
    end

    isBusy = false
    print("[AutoBuyer] Cycle complete. isBusy reset.")
end

player.CharacterAdded:Connect(function(char)
    character = char
    rootPart = char:WaitForChild("HumanoidRootPart")
    humanoid = char:WaitForChild("Humanoid")
    isBusy = false
    lastFired = 0
    recentlyFired = {}
    print("[AutoBuyer] Character respawned, state reset.")
end)

task.spawn(function()
    while true do
        task.wait(0.5)
        if getgenv().AutoBuyerEnabled then
            findAndFire()
        end
    end
end)
