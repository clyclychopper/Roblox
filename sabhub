--// BRAINROT VIEWER v3 â€” Compact Black Modern
--// Sleek, dense, all info retained. No fluff.

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

local GITHUB_TOKEN = getgenv().GithubToken or error("âŒ Set getgenv().GithubToken first")
local GIST_ID = getgenv().GistID or error("âŒ Set getgenv().GistID first")
local GIST_FILENAME = "brainrot_server.json"
local REFRESH_INTERVAL = 0.5
local USE_MOCK_DATA = false
local lastKnownTimestamp = 0

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  THEME â€” Pitch Black Modern
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local T = {
    Bg          = Color3.fromRGB(8, 8, 8),
    Panel       = Color3.fromRGB(14, 14, 14),
    Card        = Color3.fromRGB(20, 20, 20),
    CardHover   = Color3.fromRGB(26, 26, 26),
    Border      = Color3.fromRGB(32, 32, 32),
    BorderBright= Color3.fromRGB(48, 48, 48),
    Accent      = Color3.fromRGB(255, 255, 255),
    AccentDim   = Color3.fromRGB(180, 180, 180),
    AccentSub   = Color3.fromRGB(100, 100, 100),
    Green       = Color3.fromRGB(74, 222, 128),
    GreenDim    = Color3.fromRGB(34, 120, 60),
    Yellow      = Color3.fromRGB(250, 204, 21),
    Orange      = Color3.fromRGB(251, 146, 60),
    Red         = Color3.fromRGB(248, 113, 113),
    Purple      = Color3.fromRGB(167, 139, 250),
    Blue        = Color3.fromRGB(96, 165, 250),
    Cyan        = Color3.fromRGB(34, 211, 238),
    Text        = Color3.fromRGB(240, 240, 240),
    TextMid     = Color3.fromRGB(160, 160, 160),
    TextDim     = Color3.fromRGB(90, 90, 90),
    Gold        = Color3.fromRGB(251, 191, 36),
    Transparent = Color3.fromRGB(0, 0, 0),
}

local RARITY = {
    ["OG"]      = "rainbow",
    ["Secret"]  = Color3.fromRGB(220, 220, 220),
    ["God"]     = Color3.fromRGB(248, 113, 113),
    ["Burat"]   = Color3.fromRGB(74, 222, 128),
    ["Unknown"] = Color3.fromRGB(80, 80, 80),
}

local PING_NAMES = {
    ["Rosetti Tualetti"]=true,["Rosey and Teddy"]=true,["Los Amigos"]=true,
    ["Smurf Cat"]=true,["John Pork"]=true,["Dragon Cannelloni"]=true,
    ["Meowl"]=true,["Strawberry Elephant"]=true,["Ketchuru and Masturu"]=true,
    ["Ketupat Kepat"]=true,["Tang Tang Kelentang"]=true,["La Secret Combinasion"]=true,
    ["Los Bros"]=true,["Los Hotspotsitos"]=true,["Spaghetti Tualetti"]=true,
    ["Garama and Madundung"]=true,["Nuclearo Dinosauro"]=true,["Los Tacoritas"]=true,
    ["Tictac Sahur"]=true,["La Supreme Combinasion"]=true,["Los Combinasionas"]=true,
    ["La Casa Boo"]=true,["Los Spooky Combinasionas"]=true,["Reinito Sleighito"]=true,
    ["Sammyni Fattini"]=true,["Ketupat Bros"]=true,["Burguro And Fryuro"]=true,
    ["Lavadorito Spinito"]=true,["Hydra Dragon Cannelloni"]=true,["Dragon Gingerini"]=true,
    ["Cerberus"]=true,["Capitano Moby"]=true,["Headless Horseman"]=true,
}

local HIGH_INCOME_THRESHOLD = 500000000

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  HELPERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function getRequest()
    return (syn and syn.request) or (http and http.request) or http_request or request
end

local function short(n)
    n = tonumber(n) or 0
    local abs = math.abs(n)
    for _, s in ipairs({{1e12,"T"},{1e9,"B"},{1e6,"M"},{1e3,"K"}}) do
        if abs >= s[1] then
            return string.format("%.1f", n / s[1]):gsub("%.0$","") .. s[2]
        end
    end
    return tostring(n)
end

local function timeAgo(ts)
    local d = os.time() - ts
    if d < 0 then return "now" end
    if d < 60 then return d.."s"
    elseif d < 3600 then return math.floor(d/60).."m"
    elseif d < 86400 then return math.floor(d/3600).."h"
    else return math.floor(d/86400).."d" end
end

local function getTimeColor(ts)
    local d = (os.time() - ts) / 60
    if d >= 10 then return T.Red
    elseif d >= 5 then return T.Orange
    else return T.TextDim end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  UI HELPERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function corner(p, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r or 4)
    c.Parent = p
    return c
end

local function stroke(p, color, thick, trans)
    local s = Instance.new("UIStroke")
    s.Color = color or T.Border
    s.Thickness = thick or 1
    s.Transparency = trans or 0
    s.Parent = p
    return s
end

local function lbl(parent, props)
    local l = Instance.new("TextLabel")
    l.BackgroundTransparency = 1
    l.TextXAlignment = props.align or Enum.TextXAlignment.Left
    l.Font = props.font or Enum.Font.Code
    l.TextSize = props.size or 12
    l.TextColor3 = props.color or T.Text
    l.Text = props.text or ""
    l.Size = props.sz or UDim2.new(1,0,1,0)
    l.Position = props.pos or UDim2.new(0,0,0,0)
    l.TextTruncate = props.trunc and Enum.TextTruncate.AtEnd or Enum.TextTruncate.None
    l.Parent = parent
    return l
end

local function frm(parent, props)
    local f = Instance.new("Frame")
    f.Size = props.sz or UDim2.new(1,0,0,32)
    f.Position = props.pos or UDim2.new(0,0,0,0)
    f.BackgroundColor3 = props.bg or T.Panel
    f.BorderSizePixel = 0
    f.Parent = parent
    return f
end

local function pill(parent, text, color, xOff, yOff, w)
    local p = frm(parent, {sz=UDim2.new(0,w or 52,0,18), pos=UDim2.new(1,xOff,0,yOff), bg=T.Bg})
    corner(p, 3)
    stroke(p, color, 1, 0.4)
    lbl(p, {text=text, size=10, color=color, font=Enum.Font.Code, align=Enum.TextXAlignment.Center})
    return p
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  FETCH
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function fetchGistData()
    if USE_MOCK_DATA then
        return {
            jobId="mock-bot", placeId=109983668079237, timestamp=os.time(), playerCount=0,
            brainrots={
                {name="Dragon Cannelloni",rarity="Secret",mutation="Rainbow",traits="Lightning",income=500000000,cost=250000000000,serverId="srv-abc123",foundAt=os.time()-60,playerCount=8},
                {name="Meowl",rarity="OG",mutation="Divine",traits="Meowl",income=800000000,cost=500000000000,serverId="srv-abc123",foundAt=os.time()-30,playerCount=8},
                {name="Ultra Rat",rarity="God",mutation="Cosmic",traits="Speed",income=120000000,cost=999000000000,serverId="srv-xyz789",foundAt=os.time()-10,playerCount=12},
                {name="Smurf Cat",rarity="Burat",mutation="Frost",traits="Chill",income=45000000,cost=50000000000,serverId="srv-xyz789",foundAt=os.time()-200,playerCount=12},
            }
        }
    end
    local req = getRequest()
    if not req then return nil end
    local ok, result = pcall(function()
        local res = req({
            Url = "https://api.github.com/gists/"..GIST_ID,
            Method = "GET",
            Headers = {
                ["Authorization"] = "token "..GITHUB_TOKEN,
                ["User-Agent"] = "Roblox-Brainrot-Viewer"
            }
        })
        if res.StatusCode == 200 then
            local data = HttpService:JSONDecode(res.Body)
            return HttpService:JSONDecode(data.files[GIST_FILENAME].content)
        end
    end)
    return ok and result or nil
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  BUILD GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function buildGUI()
    local old = CoreGui:FindFirstChild("BrainrotViewerV3")
    if old then old:Destroy() end

    local sg = Instance.new("ScreenGui")
    sg.Name = "BrainrotViewerV3"
    sg.ResetOnSpawn = false
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- â”€â”€ Main Window (compact: 560 Ã— 460) â”€â”€â”€â”€â”€â”€â”€
    local win = Instance.new("Frame")
    win.Name = "Window"
    win.Size = UDim2.new(0, 560, 0, 460)
    win.Position = UDim2.new(0.5, -280, 0.5, -230)
    win.BackgroundColor3 = T.Bg
    win.BorderSizePixel = 0
    win.Parent = sg
    corner(win, 8)
    stroke(win, T.BorderBright, 1, 0)

    -- â”€â”€ Title Bar (34px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local titleBar = Instance.new("TextButton")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1,0,0,34)
    titleBar.BackgroundColor3 = T.Panel
    titleBar.BorderSizePixel = 0
    titleBar.Text = ""
    titleBar.AutoButtonColor = false
    titleBar.Parent = win
    corner(titleBar, 8)
    
    -- Bottom border separator
    local sep = frm(win, {sz=UDim2.new(1,0,0,1), pos=UDim2.new(0,0,0,34), bg=T.BorderBright})

    -- Logo dot
    local logoDot = frm(titleBar, {sz=UDim2.new(0,8,0,8), pos=UDim2.new(0,12,0,13), bg=T.Green})
    corner(logoDot, 4)

    -- Title
    lbl(titleBar, {
        text="CLY NOTIFY", size=12, color=T.Text, font=Enum.Font.Code,
        sz=UDim2.new(0,180,1,0), pos=UDim2.new(0,28,0,0),
        align=Enum.TextXAlignment.Left
    })

    -- Status (right of title)
    local statusLbl = Instance.new("TextLabel")
    statusLbl.Name = "StatusLbl"
    statusLbl.BackgroundTransparency = 1
    statusLbl.Size = UDim2.new(0,100,1,0)
    statusLbl.Position = UDim2.new(0,130,0,0)
    statusLbl.Font = Enum.Font.Code
    statusLbl.TextSize = 10
    statusLbl.TextColor3 = T.TextDim
    statusLbl.Text = "syncing..."
    statusLbl.TextXAlignment = Enum.TextXAlignment.Left
    statusLbl.Parent = titleBar

    -- Title bar right side layout (from right edge, no overlaps):
    --  [âœ•]       pos X: UDim2(1,-30, ...)   width 22
    --  [â€“]       pos X: UDim2(1,-56, ...)   width 22
    --  [â†º]       pos X: UDim2(1,-82, ...)   width 22
    --  divider   pos X: UDim2(1,-92, ...)   width 1
    --  chip "Servers" pos X: UDim2(1,-182, ...)  width 88
    --  divider   pos X: UDim2(1,-190, ...)  width 1
    --  chip "Total"   pos X: UDim2(1,-280, ...)  width 88

    -- Helper: small 22Ã—22 action button with solid bg
    local function winBtn(xPos, sym, normalBg, hoverBg, normalCol, hoverCol)
        local b = Instance.new("TextButton")
        b.Size = UDim2.new(0,22,0,22)
        b.Position = UDim2.new(1,xPos,0,6)
        b.BackgroundColor3 = normalBg
        b.Text = sym
        b.TextColor3 = normalCol
        b.TextSize = 12
        b.Font = Enum.Font.GothamBold
        b.BorderSizePixel = 0
        b.AutoButtonColor = false
        b.Parent = titleBar
        corner(b, 4)
        b.MouseEnter:Connect(function()
            b.BackgroundColor3 = hoverBg
            b.TextColor3 = hoverCol
        end)
        b.MouseLeave:Connect(function()
            b.BackgroundColor3 = normalBg
            b.TextColor3 = normalCol
        end)
        return b
    end

    -- âœ• close â€” rightmost
    local closeBtn = winBtn(-30, "âœ•",
        Color3.fromRGB(48,18,18), Color3.fromRGB(239,68,68),
        Color3.fromRGB(239,68,68), Color3.fromRGB(255,255,255))

    -- â€“ minimize
    local minimizeBtn = winBtn(-56, "â€“",
        Color3.fromRGB(30,30,30), Color3.fromRGB(50,50,50),
        Color3.fromRGB(160,160,160), Color3.fromRGB(220,220,220))

    -- â†º resync
    local resyncBtn = winBtn(-82, "â†º",
        Color3.fromRGB(18,30,20), Color3.fromRGB(20,50,25),
        Color3.fromRGB(74,222,128), Color3.fromRGB(134,239,172))
    resyncBtn.Name = "ResyncBtn"

    -- Divider before chips
    frm(titleBar, {sz=UDim2.new(0,1,0,16), pos=UDim2.new(1,-94,0,9), bg=T.BorderBright})

    -- Stat chips â€” each 88px wide
    local function tinyChip(icon, key, xOff, accentCol)
        local chip = frm(titleBar, {sz=UDim2.new(0,88,0,22), pos=UDim2.new(1,xOff,0,6), bg=T.Card})
        corner(chip, 4)
        stroke(chip, T.Border, 1, 0)
        local chipAccent = frm(chip, {sz=UDim2.new(0,2,0,12), pos=UDim2.new(0,0,0,5), bg=accentCol or T.AccentSub})
        corner(chipAccent, 1)
        lbl(chip, {text=icon, size=10, color=T.TextDim, font=Enum.Font.Code,
            sz=UDim2.new(0,20,1,0), pos=UDim2.new(0,6,0,0), align=Enum.TextXAlignment.Center})
        local val = Instance.new("TextLabel")
        val.Name = key
        val.BackgroundTransparency = 1
        val.Size = UDim2.new(1,-28,1,0)
        val.Position = UDim2.new(0,28,0,0)
        val.Font = Enum.Font.Code
        val.TextSize = 11
        val.TextColor3 = T.Text
        val.Text = "0"
        val.TextXAlignment = Enum.TextXAlignment.Left
        val.Parent = chip
        return val
    end

    local serverLbl = tinyChip("ðŸ–¥", "ServerLbl", -183, T.Blue)
    frm(titleBar, {sz=UDim2.new(0,1,0,16), pos=UDim2.new(1,-191,0,9), bg=T.BorderBright})
    local totalLbl  = tinyChip("ðŸ“¦", "TotalLbl",  -280, T.Green)

    -- â”€â”€ Scroll Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local scroll = Instance.new("ScrollingFrame")
    scroll.Name = "Scroll"
    scroll.Size = UDim2.new(1,-2,1,-36)
    scroll.Position = UDim2.new(0,1,0,36)
    scroll.BackgroundTransparency = 1
    scroll.BorderSizePixel = 0
    scroll.ScrollBarThickness = 3
    scroll.ScrollBarImageColor3 = T.BorderBright
    scroll.CanvasSize = UDim2.new(0,0,0,0)
    scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    scroll.Parent = win

    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0,1)
    listLayout.Parent = scroll

    local pad = Instance.new("UIPadding")
    pad.PaddingTop    = UDim.new(0,6)
    pad.PaddingBottom = UDim.new(0,6)
    pad.PaddingLeft   = UDim.new(0,6)
    pad.PaddingRight  = UDim.new(0,6)
    pad.Parent = scroll

    sg.Parent = CoreGui

    return {
        gui=sg, win=win, titleBar=titleBar, scroll=scroll,
        statusLbl=statusLbl, totalLbl=totalLbl, serverLbl=serverLbl,
        closeBtn=closeBtn, minimizeBtn=minimizeBtn, resyncBtn=resyncBtn,
    }
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  SERVER PANEL
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function buildServerPanel(serverId, brainrots, placeId, parent, order)
    table.sort(brainrots, function(a,b)
        local aPing = PING_NAMES[a.name] and 1 or 0
        local bPing = PING_NAMES[b.name] and 1 or 0
        if aPing ~= bPing then return aPing > bPing end
        return (a.income or 0) > (b.income or 0)
    end)

    local isCurrentServer = (serverId == game.JobId)
    local playerCount = brainrots[1] and brainrots[1].playerCount or 0
    local shortId = serverId:sub(1,14).."â€¦"

    local isHighlighted = false
    for _, br in ipairs(brainrots) do
        if (br.income or 0) >= HIGH_INCOME_THRESHOLD then
            isHighlighted = true; break
        end
    end

    -- Wrapper
    local wrapper = Instance.new("Frame")
    wrapper.Size = UDim2.new(1,0,0,0)
    wrapper.AutomaticSize = Enum.AutomaticSize.Y
    wrapper.BackgroundTransparency = 1
    wrapper.BorderSizePixel = 0
    wrapper.LayoutOrder = order
    wrapper.Parent = parent

    -- Panel card
    local panel = Instance.new("Frame")
    panel.Size = UDim2.new(1,0,0,0)
    panel.AutomaticSize = Enum.AutomaticSize.Y
    panel.BackgroundColor3 = T.Panel
    panel.BorderSizePixel = 0
    panel.Parent = wrapper
    corner(panel, 6)
    
    local borderColor = isHighlighted and T.Gold or (isCurrentServer and T.Cyan or T.Border)
    stroke(panel, borderColor, 1, 0)

    local panelLayout = Instance.new("UIListLayout")
    panelLayout.SortOrder = Enum.SortOrder.LayoutOrder
    panelLayout.Padding = UDim.new(0,0)
    panelLayout.Parent = panel

    -- â”€â”€ Server Header (28px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local header = Instance.new("TextButton")
    header.Size = UDim2.new(1,0,0,28)
    header.BackgroundColor3 = T.Card
    header.BorderSizePixel = 0
    header.Text = ""
    header.AutoButtonColor = false
    header.LayoutOrder = 1
    header.Parent = panel
    corner(header, 6)

    -- Left accent strip (2px)
    local strip = frm(header, {sz=UDim2.new(0,2,0,16), pos=UDim2.new(0,8,0,6),
        bg=isHighlighted and T.Gold or (isCurrentServer and T.Cyan or T.AccentSub)})
    corner(strip, 1)

    -- Server ID (takes most of the left space now)
    lbl(header, {
        text=(isHighlighted and "â˜… " or "")..shortId,
        size=11, color=isHighlighted and T.Gold or T.TextMid, font=Enum.Font.Code,
        sz=UDim2.new(1,-100,1,0), pos=UDim2.new(0,18,0,0),
        align=Enum.TextXAlignment.Left, trunc=true
    })

    -- Right-side cluster: [ðŸ‘¥N] [+N] [â–¾] [JOIN â†’]
    -- Layout from right: join@-68, chevron@-86, found@-130, players@-178

    -- Player count pill
    local plrPill = frm(header, {sz=UDim2.new(0,40,0,18), pos=UDim2.new(1,-226,0,5), bg=T.Bg})
    corner(plrPill, 3)
    stroke(plrPill, T.Border, 1, 0)
    lbl(plrPill, {text="ðŸ‘¥"..playerCount, size=10, color=T.TextDim, font=Enum.Font.Code, align=Enum.TextXAlignment.Center})

    -- Found count pill
    local foundPill = frm(header, {sz=UDim2.new(0,36,0,18), pos=UDim2.new(1,-180,0,5), bg=T.Bg})
    corner(foundPill, 3)
    stroke(foundPill, T.GreenDim, 1, 0)
    lbl(foundPill, {text="+"..#brainrots, size=10, color=T.Green, font=Enum.Font.Code, align=Enum.TextXAlignment.Center})

    -- Thin separator before join area
    frm(header, {sz=UDim2.new(0,1,0,14), pos=UDim2.new(1,-138,0,7), bg=T.BorderBright})

    -- Join / Current badge â€” pinned to absolute right edge
    -- badge width=62, right margin=6 â†’ Position X = UDim2(1,-68,...)
    -- chevron sits just left of badge: X = UDim2(1,-86,...)
    local isOpen = true
    local chevron = lbl(header, {
        text="â–¾", size=13, color=T.TextDim, font=Enum.Font.Code,
        sz=UDim2.new(0,16,1,0), pos=UDim2.new(1,-86,0,0),
        align=Enum.TextXAlignment.Center
    })

    if isCurrentServer then
        local here = frm(header, {sz=UDim2.new(0,62,0,18), pos=UDim2.new(1,-68,0,5), bg=T.Bg})
        corner(here, 3)
        stroke(here, T.Cyan, 1, 0.3)
        lbl(here, {text="â— HERE", size=10, color=T.Cyan, font=Enum.Font.Code, align=Enum.TextXAlignment.Center})
    else
        local joinBtn = Instance.new("TextButton")
        joinBtn.Size = UDim2.new(0,62,0,18)
        joinBtn.Position = UDim2.new(1,-68,0,5)
        joinBtn.BackgroundColor3 = Color3.fromRGB(22,22,22)
        joinBtn.Text = "JOIN â†’"
        joinBtn.TextColor3 = T.TextMid
        joinBtn.TextSize = 10
        joinBtn.Font = Enum.Font.Code
        joinBtn.BorderSizePixel = 0
        joinBtn.AutoButtonColor = false
        joinBtn.Parent = header
        corner(joinBtn, 3)
        stroke(joinBtn, T.BorderBright, 1, 0)
        joinBtn.MouseEnter:Connect(function()
            joinBtn.BackgroundColor3 = Color3.fromRGB(34,34,34)
            joinBtn.TextColor3 = T.Green
        end)
        joinBtn.MouseLeave:Connect(function()
            joinBtn.BackgroundColor3 = Color3.fromRGB(22,22,22)
            joinBtn.TextColor3 = T.TextMid
        end)
        joinBtn.MouseButton1Click:Connect(function()
            joinBtn.Text = "..."
            pcall(function()
                TeleportService:TeleportToPlaceInstance(placeId, serverId, Players.LocalPlayer)
            end)
        end)
    end

    -- â”€â”€ Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local body = Instance.new("Frame")
    body.Size = UDim2.new(1,0,0,0)
    body.AutomaticSize = Enum.AutomaticSize.Y
    body.BackgroundTransparency = 1
    body.BorderSizePixel = 0
    body.LayoutOrder = 2
    body.ClipsDescendants = false
    body.Parent = panel

    local bodyPad = Instance.new("UIPadding")
    bodyPad.PaddingLeft   = UDim.new(0,6)
    bodyPad.PaddingRight  = UDim.new(0,6)
    bodyPad.PaddingTop    = UDim.new(0,3)
    bodyPad.PaddingBottom = UDim.new(0,6)
    bodyPad.Parent = body

    local bodyLayout = Instance.new("UIListLayout")
    bodyLayout.SortOrder = Enum.SortOrder.LayoutOrder
    bodyLayout.Padding = UDim.new(0,2)
    bodyLayout.Parent = body

    -- â”€â”€ Brainrot Rows (compact 52px each) â”€â”€â”€â”€â”€
    for i, br in ipairs(brainrots) do
        local rarityColor = RARITY[br.rarity] or RARITY["Unknown"]
        local isRainbow = (rarityColor == "rainbow")
        local isPing = PING_NAMES[br.name]

        local row = Instance.new("Frame")
        row.Size = UDim2.new(1,0,0,52)
        row.BackgroundColor3 = T.Bg
        row.BorderSizePixel = 0
        row.LayoutOrder = i
        row.Parent = body
        corner(row, 4)
        stroke(row, isPing and Color3.fromRGB(40,40,60) or T.Border, 1, 0)

        -- Ping dot (bright yellow, top-left corner)
        if isPing then
            local dot = frm(row, {sz=UDim2.new(0,6,0,6), pos=UDim2.new(0,4,0,4), bg=Color3.fromRGB(250,204,21)})
            corner(dot, 4)
            -- glow stroke
            local dotStroke = Instance.new("UIStroke")
            dotStroke.Color = Color3.fromRGB(253,224,71)
            dotStroke.Thickness = 1.5
            dotStroke.Transparency = 0.3
            dotStroke.Parent = dot
        end

        -- Left rarity bar (2px)
        local rarBar = frm(row, {sz=UDim2.new(0,2,0,36), pos=UDim2.new(0,6,0,8),
            bg=isRainbow and Color3.fromRGB(255,0,200) or rarityColor})
        corner(rarBar, 1)
        if isRainbow then
            local rg = Instance.new("UIGradient")
            rg.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0.0,  Color3.fromRGB(255,0,0)),
                ColorSequenceKeypoint.new(0.25, Color3.fromRGB(255,200,0)),
                ColorSequenceKeypoint.new(0.5,  Color3.fromRGB(0,255,100)),
                ColorSequenceKeypoint.new(0.75, Color3.fromRGB(0,100,255)),
                ColorSequenceKeypoint.new(1.0,  Color3.fromRGB(200,0,255)),
            })
            rg.Rotation = 90
            rg.Parent = rarBar
        end

        -- â”€â”€ Row line 1: Name + rarity + time â”€â”€
        lbl(row, {
            text=br.name, size=12, color=T.Text, font=Enum.Font.Code,
            sz=UDim2.new(1,-145,0,16), pos=UDim2.new(0,16,0,6),
            align=Enum.TextXAlignment.Left, trunc=true
        })

        -- Rarity badge (right side)
        local rCol = isRainbow and Color3.fromRGB(200,100,255) or rarityColor
        local rb = frm(row, {sz=UDim2.new(0,52,0,15), pos=UDim2.new(1,-110,0,7), bg=T.Bg})
        corner(rb, 3)
        stroke(rb, rCol, 1, 0.3)
        local rLbl = lbl(rb, {
            text=br.rarity, size=9, color=rCol, font=Enum.Font.Code,
            align=Enum.TextXAlignment.Center
        })
        if isRainbow then
            local rg2 = Instance.new("UIGradient")
            rg2.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0,   Color3.fromRGB(255,80,80)),
                ColorSequenceKeypoint.new(0.5, Color3.fromRGB(80,255,180)),
                ColorSequenceKeypoint.new(1,   Color3.fromRGB(180,80,255)),
            })
            rg2.Parent = rLbl
        end

        -- Time ago
        lbl(row, {
            text=timeAgo(br.foundAt), size=10, color=getTimeColor(br.foundAt), font=Enum.Font.Code,
            sz=UDim2.new(0,44,0,15), pos=UDim2.new(1,-54,0,8),
            align=Enum.TextXAlignment.Right
        })

        -- â”€â”€ Row line 2: Income | Cost | Mutation | Traits â”€â”€
        local line2 = frm(row, {sz=UDim2.new(1,-16,0,16), pos=UDim2.new(0,16,0,28), bg=T.Transparent})
        line2.BackgroundTransparency = 1

        local l2layout = Instance.new("UIListLayout")
        l2layout.FillDirection = Enum.FillDirection.Horizontal
        l2layout.VerticalAlignment = Enum.VerticalAlignment.Center
        l2layout.Padding = UDim.new(0,0)
        l2layout.Parent = line2

        local function stat2(icon, val, col, w)
            local s = frm(line2, {sz=UDim2.new(0,w,1,0), bg=T.Transparent})
            s.BackgroundTransparency = 1
            lbl(s, {text=icon..val, size=10, color=col, font=Enum.Font.Code, align=Enum.TextXAlignment.Left})
        end

        stat2("$", short(br.income).."/s", T.Green, 100)
        stat2("Â¢", short(br.cost),          T.Yellow, 86)
        stat2("â—ˆ", br.mutation or "â€”",      T.TextDim, 90)
        stat2("â—Ž", br.traits or "â€”",        T.TextDim, 0)
    end

    -- â”€â”€ Dropdown toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local function setOpen(open)
        isOpen = open
        body.Visible = open
        chevron.Text = open and "â–¾" or "â–¸"
        chevron.TextColor3 = open and T.TextMid or T.TextDim
    end

    header.MouseButton1Click:Connect(function() setOpen(not isOpen) end)
    header.MouseEnter:Connect(function() header.BackgroundColor3 = T.CardHover end)
    header.MouseLeave:Connect(function() header.BackgroundColor3 = T.Card end)

    return wrapper
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  UPDATE GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function updateGUI(ui, data)
    if not data then
        ui.statusLbl.Text = "Â· error"
        ui.statusLbl.TextColor3 = T.Red
        return
    end

    ui.statusLbl.Text = "Â· "..timeAgo(data.timestamp).." ago"
    ui.statusLbl.TextColor3 = T.Green

    for _, ch in ipairs(ui.scroll:GetChildren()) do
        if ch:IsA("Frame") then ch:Destroy() end
    end

    local groups = {}
    for _, br in ipairs(data.brainrots or {}) do
        local sid = br.serverId or "unknown"
        groups[sid] = groups[sid] or {}
        table.insert(groups[sid], br)
    end

    local total, serverCount = #(data.brainrots or {}), 0
    for _ in pairs(groups) do serverCount = serverCount + 1 end

    ui.totalLbl.Text  = tostring(total)
    ui.serverLbl.Text = tostring(serverCount).." srv"

    local sorted = {}
    for sid, brs in pairs(groups) do
        local t = 0
        for _, b in ipairs(brs) do if b.foundAt > t then t = b.foundAt end end
        table.insert(sorted, {id=sid, brs=brs, latest=t})
    end
    table.sort(sorted, function(a,b) return a.latest > b.latest end)

    for idx, s in ipairs(sorted) do
        buildServerPanel(s.id, s.brs, data.placeId, ui.scroll, idx)
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  MAIN
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function main()
    local ui = buildGUI()

    ui.closeBtn.MouseButton1Click:Connect(function()
        ui.gui:Destroy()
    end)

    local minimized = false
    ui.minimizeBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        ui.scroll.Visible = not minimized
        ui.win.Size = minimized
            and UDim2.new(0,560,0,36)
            or  UDim2.new(0,560,0,460)
        ui.minimizeBtn.Text = minimized and "â–¡" or "â€”"
    end)

    -- Shared sync function used by both auto-loop and resync button
    local isSyncing = false
    local lastAutoSync = os.time()
    local AUTO_RESYNC_INTERVAL = 30 -- force UI refresh every 30s even if no new data

    local function doSync(force)
        if isSyncing then return end
        isSyncing = true
        ui.resyncBtn.Text = "â†»"
        ui.resyncBtn.TextColor3 = T.Yellow
        local newData = fetchGistData()
        if ui.gui.Parent and newData then
            -- Update UI if data changed OR forced (resets the "X ago" timer display)
            if force or newData.timestamp ~= lastKnownTimestamp then
                lastKnownTimestamp = newData.timestamp
                updateGUI(ui, newData)
                print("[Viewer] ðŸ”„ Synced" .. (force and " (manual)" or " (new data)"))
            end
        end
        ui.resyncBtn.Text = "â†º"
        ui.resyncBtn.TextColor3 = T.TextDim
        isSyncing = false
        lastAutoSync = os.time()
    end

    -- Initial load
    doSync(true)

    -- Manual resync button
    ui.resyncBtn.MouseButton1Click:Connect(function()
        task.spawn(function() doSync(true) end)
    end)

    -- Auto loop: check every REFRESH_INTERVAL, force-resync every 30s
    task.spawn(function()
        while ui.gui.Parent do
            task.wait(REFRESH_INTERVAL)
            if not ui.gui.Parent then break end
            local shouldForce = (os.time() - lastAutoSync) >= AUTO_RESYNC_INTERVAL
            task.spawn(function() doSync(shouldForce) end)
        end
    end)

    -- Draggable
    local dragging, dragStart, winStart
    ui.titleBar.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = inp.Position
            winStart = ui.win.Position
            inp.Changed:Connect(function()
                if inp.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    local lastDrag
    ui.titleBar.InputChanged:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseMovement then lastDrag = inp end
    end)
    UserInputService.InputChanged:Connect(function(inp)
        if inp == lastDrag and dragging then
            local delta = inp.Position - dragStart
            ui.win.Position = UDim2.new(
                winStart.X.Scale, winStart.X.Offset + delta.X,
                winStart.Y.Scale, winStart.Y.Offset + delta.Y
            )
        end
    end)
end

main()
