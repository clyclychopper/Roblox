--// GIST VIEWER GUI v2
--// Reads brainrot data from GitHub Gist and displays grouped by server
--// Design: Terminal/Monitor aesthetic â€” neon cyan on deep slate

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

local GITHUB_TOKEN = getgenv().GithubToken or error("âŒ Set getgenv().GithubToken first")
local GIST_ID = getgenv().GistID or error("âŒ Set getgenv().GistID first")
local GIST_FILENAME = "brainrot_server.json"
local REFRESH_INTERVAL = 2  -- Check every 2 seconds for fast sync
local USE_MOCK_DATA = false
local lastKnownTimestamp = 0  -- Track last update to avoid redundant UI refreshes

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  THEME â€” Grey Modern
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local T = {
    Bg          = Color3.fromRGB(45, 52, 64),
    Panel       = Color3.fromRGB(55, 62, 74),
    Card        = Color3.fromRGB(65, 72, 84),
    CardHover   = Color3.fromRGB(75, 82, 94),
    Border      = Color3.fromRGB(85, 92, 104),
    Accent      = Color3.fromRGB(88, 166, 255),
    AccentDim   = Color3.fromRGB(68, 146, 235),
    AccentGlow  = Color3.fromRGB(108, 186, 255),
    Green       = Color3.fromRGB(76, 209, 55),
    Yellow      = Color3.fromRGB(241, 196, 15),
    Orange      = Color3.fromRGB(230, 126, 34),
    Red         = Color3.fromRGB(231, 76, 60),
    Purple      = Color3.fromRGB(155, 89, 182),
    Blue        = Color3.fromRGB(52, 152, 219),
    Text        = Color3.fromRGB(236, 240, 241),
    TextMid     = Color3.fromRGB(189, 195, 199),
    TextDim     = Color3.fromRGB(127, 140, 141),
    Transparent = Color3.fromRGB(0, 0, 0),
}

local RARITY = {
    ["OG"]      = "rainbow",  -- special case for gradient
    ["Secret"]  = Color3.fromRGB(255, 255, 255),
    ["God"]     = Color3.fromRGB(239, 68, 68),
    ["Burat"]   = Color3.fromRGB(34, 197, 94),
    ["Unknown"] = Color3.fromRGB(148, 163, 184),
}

-- Priority brainrots to highlight
local PING_NAMES = {
    ["Rosetti Tualetti"] = true,
    ["Rosey and Teddy"] = true,
    ["Los Amigos"] = true,
    ["Smurf Cat"] = true,
    ["John Pork"] = true,
    ["Dragon Cannelloni"] = true,
    ["Meowl"] = true,
    ["Strawberry Elephant"] = true,
    ["Ketchuru and Masturu"] = true,
    ["Ketupat Kepat"] = true,
    ["Tang Tang Kelentang"] = true,
    ["La Secret Combinasion"] = true,
    ["Los Bros"] = true,
    ["Los Hotspotsitos"] = true,
    ["Spaghetti Tualetti"] = true,
    ["Garama and Madundung"] = true,
    ["Nuclearo Dinosauro"] = true,
    ["Los Tacoritas"] = true,
    ["Tictac Sahur"] = true,
    ["La Supreme Combinasion"] = true,
    ["Los Combinasionas"] = true,
    ["La Casa Boo"] = true,
    ["Los Spooky Combinasionas"] = true,
    ["Reinito Sleighito"] = true,
    ["Sammyni Fattini"] = true,
    ["Ketupat Bros"] = true,
    ["Burguro And Fryuro"] = true,
    ["Lavadorito Spinito"] = true,
    ["Hydra Dragon Cannelloni"] = true,
    ["Dragon Gingerini"] = true,
    ["Cerberus"] = true,
    ["Capitano Moby"] = true,
    ["Headless Horseman"] = true,
    ["Spaghetti Tualetti"] = true,
    
}

local HIGH_INCOME_THRESHOLD = 500000000  -- 500M/s

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  HELPERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function getRequest()
    return (syn and syn.request) or (http and http.request) or http_request or request
end

local function short(n)
    n = tonumber(n) or 0
    local abs = math.abs(n)
    for _, s in ipairs({{1e12,"T"},{1e9,"B"},{1e6,"M"},{1e3,"K"}}) do
        if abs >= s[1] then
            return string.format("%.2f", n / s[1]):gsub("%.00$","") .. s[2]
        end
    end
    return tostring(n)
end

local function timeAgo(ts)
    local d = os.time() - ts
    if d < 60 then return d.."s" elseif d < 3600 then return math.floor(d/60).."m"
    elseif d < 86400 then return math.floor(d/3600).."h" else return math.floor(d/86400).."d" end
end

local function getTimeColor(ts)
    local d = os.time() - ts
    local minutes = d / 60
    if minutes >= 10 then
        return T.Red
    elseif minutes >= 5 then
        return T.Orange
    else
        return T.TextDim
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  UI HELPERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function corner(parent, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r or 4)
    c.Parent = parent
end

local function stroke(parent, color, thickness, transparency)
    local s = Instance.new("UIStroke")
    s.Color = color or T.Border
    s.Thickness = thickness or 1
    s.Transparency = transparency or 0
    s.Parent = parent
end

local function label(parent, props)
    local l = Instance.new("TextLabel")
    l.BackgroundTransparency = 1
    l.TextXAlignment = props.align or Enum.TextXAlignment.Left
    l.Font = props.font or Enum.Font.Code
    l.TextSize = props.size or 13
    l.TextColor3 = props.color or T.Text
    l.Text = props.text or ""
    l.Size = props.sz or UDim2.new(1,0,1,0)
    l.Position = props.pos or UDim2.new(0,0,0,0)
    l.TextTruncate = props.truncate and Enum.TextTruncate.AtEnd or Enum.TextTruncate.None
    l.Parent = parent
    return l
end

local function frame(parent, props)
    local f = Instance.new("Frame")
    f.Size = props.sz or UDim2.new(1,0,0,40)
    f.Position = props.pos or UDim2.new(0,0,0,0)
    f.BackgroundColor3 = props.bg or T.Panel
    f.BorderSizePixel = 0
    f.Parent = parent
    return f
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  FETCH
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function fetchGistData()
    if USE_MOCK_DATA then
        return {
            jobId="master-bot", placeId=109983668079237,
            timestamp=os.time(), playerCount=0,
            brainrots={
                                {name="Chicleteira Noelteira",rarity="Secret",mutation="Lava",traits="Nyan, Fire",income=360000,cost=2000000000,serverId="server-abc123def456",foundAt=os.time()-120,playerCount=12},
                {name="Dragon Cannelloni",rarity="Secret",mutation="Rainbow",traits="Lightning",income=500000000,cost=250000000000,serverId="server-xyz789ghi012",foundAt=os.time()-60,playerCount=8},
                {name="Meowl",rarity="OG",mutation="Divine",traits="Meowl",income=800000000,cost=500000000000,serverId="server-abc123def456",foundAt=os.time()-30,playerCount=12},
                {name="Ultra Rat",rarity="God",mutation="Cosmic",traits="Speed",income=1200000000,cost=999000000000,serverId="server-abc123def456",foundAt=os.time()-10,playerCount=12},
            }
        }
    end
    local req = getRequest()
    if not req then return nil end
    local ok, result = pcall(function()
        local res = req({
            Url = "https://api.github.com/gists/"..GIST_ID,
            Method = "GET",
            Headers = {
                ["Authorization"] = "token "..GITHUB_TOKEN,
                ["User-Agent"] = "Roblox-Brainrot-Viewer"
            }
        })
        if res.StatusCode == 200 then
            local data = HttpService:JSONDecode(res.Body)
            return HttpService:JSONDecode(data.files[GIST_FILENAME].content)
        end
    end)
    return ok and result or nil
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  BUILD GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function buildGUI()
    local old = CoreGui:FindFirstChild("BrainrotViewerV2")
    if old then old:Destroy() end

    local sg = Instance.new("ScreenGui")
    sg.Name = "BrainrotViewerV2"
    sg.ResetOnSpawn = false
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- â”€â”€ Main Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local win = Instance.new("Frame")
    win.Name = "Window"
    win.Size = UDim2.new(0, 760, 0, 640)
    win.Position = UDim2.new(0.5, -380, 0.5, -320)
    win.BackgroundColor3 = T.Bg
    win.BorderSizePixel = 0
    win.Parent = sg
    corner(win, 6)
    stroke(win, T.Accent, 1, 0.55)

            -- Subtle gradient overlay on top of window
    local winGrad = Instance.new("UIGradient")
    winGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(55, 62, 74)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(45, 52, 64)),
    })
    winGrad.Rotation = 135
    winGrad.Parent = win

    -- â”€â”€ Title Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local titleBar = frame(win, {sz=UDim2.new(1,0,0,42), bg=T.Panel})
    corner(titleBar, 6)
    stroke(titleBar, T.Border, 1, 0)

        -- Accent line under title bar
    local accentLine = frame(win, {sz=UDim2.new(1,0,0,2), pos=UDim2.new(0,0,0,42), bg=T.Accent})
    local accentGrad = Instance.new("UIGradient")
    accentGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, T.Accent),
        ColorSequenceKeypoint.new(0.5, T.Purple),
        ColorSequenceKeypoint.new(1, T.Accent),
    })
    accentGrad.Parent = accentLine

    -- Title icon + text
    local titleIcon = label(titleBar, {
        text="â—ˆ", size=18, color=T.Accent, font=Enum.Font.Code,
        sz=UDim2.new(0,30,1,0), pos=UDim2.new(0,14,0,0),
        align=Enum.TextXAlignment.Left
    })
    local titleTxt = label(titleBar, {
        text="Cly Notify!", size=16, color=T.Text, font=Enum.Font.Code,
        sz=UDim2.new(0,260,1,0), pos=UDim2.new(0,42,0,0),
        align=Enum.TextXAlignment.Left
    })

    -- Status pill
    local statusPill = frame(titleBar, {sz=UDim2.new(0,120,0,22), pos=UDim2.new(1,-220,0,10), bg=T.Card})
    corner(statusPill, 11)
    stroke(statusPill, T.Border, 1, 0)
    local statusDot = label(statusPill, {
        text="â—", size=10, color=T.AccentDim, font=Enum.Font.Code,
        sz=UDim2.new(0,16,1,0), pos=UDim2.new(0,6,0,0),
        align=Enum.TextXAlignment.Left
    })
    local statusLbl = Instance.new("TextLabel")
    statusLbl.Name = "StatusLbl"
    statusLbl.Size = UDim2.new(1,-20,1,0)
    statusLbl.Position = UDim2.new(0,18,0,0)
    statusLbl.BackgroundTransparency = 1
    statusLbl.Text = "LOADING..."
    statusLbl.TextColor3 = T.TextMid
    statusLbl.TextSize = 10
    statusLbl.Font = Enum.Font.Code
    statusLbl.TextXAlignment = Enum.TextXAlignment.Left
    statusLbl.Parent = statusPill

    -- â”€â”€ Window Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local function makeWinBtn(xOffset, bgColor, symbol)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0,28,0,28)
        btn.Position = UDim2.new(1, xOffset, 0, 7)
        btn.BackgroundColor3 = bgColor
        btn.Text = symbol
        btn.TextColor3 = T.Bg
        btn.TextSize = 13
        btn.Font = Enum.Font.GothamBold
        btn.BorderSizePixel = 0
        btn.AutoButtonColor = false
        btn.Parent = titleBar
        corner(btn, 4)
        btn.MouseEnter:Connect(function()
            btn.BackgroundColor3 = Color3.new(
                math.min(bgColor.R * 1.3, 1),
                math.min(bgColor.G * 1.3, 1),
                math.min(bgColor.B * 1.3, 1)
            )
        end)
        btn.MouseLeave:Connect(function() btn.BackgroundColor3 = bgColor end)
        return btn
    end

        local closeBtn   = makeWinBtn(-38, T.Red, "âœ•")
    local minimizeBtn = makeWinBtn(-72, T.Orange, "â€”")

    -- â”€â”€ Stat Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local statBar = frame(win, {sz=UDim2.new(1,-20,0,38), pos=UDim2.new(0,10,0,54), bg=T.Panel})
    corner(statBar, 5)
    stroke(statBar, T.Border, 1, 0)

    local statLayout = Instance.new("UIListLayout")
    statLayout.FillDirection = Enum.FillDirection.Horizontal
    statLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    statLayout.Padding = UDim.new(0,0)
    statLayout.Parent = statBar

    local function statChip(icon, label_text, color, key)
        local chip = frame(statBar, {sz=UDim2.new(0,170,1,0), bg=T.Transparent})
        chip.BackgroundTransparency = 1
        local iconL = label(chip, {
            text=icon, size=13, color=color, font=Enum.Font.Code,
            sz=UDim2.new(0,20,1,0), pos=UDim2.new(0,14,0,0),
            align=Enum.TextXAlignment.Left
        })
        local lbl = label(chip, {
            text=label_text, size=12, color=T.TextMid, font=Enum.Font.Code,
            sz=UDim2.new(1,-36,1,0), pos=UDim2.new(0,32,0,0),
            align=Enum.TextXAlignment.Left
        })
        lbl.Name = key or "Stat"
        return chip, lbl
    end

    local _, totalLbl   = statChip("â—†", "BRAINROTS: 0", T.Accent, "TotalLbl")
    local _, serverLbl  = statChip("â—ˆ", "SERVERS: 0",   T.Purple, "ServerLbl")
    local _, refreshLbl = statChip("â†»", "SYNCED: --",   T.Green,  "RefreshLbl")

    -- â”€â”€ Content Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local scroll = Instance.new("ScrollingFrame")
    scroll.Name = "Scroll"
    scroll.Size = UDim2.new(1,-20,1,-110)
    scroll.Position = UDim2.new(0,10,0,104)
    scroll.BackgroundColor3 = T.Bg
    scroll.BackgroundTransparency = 1
    scroll.BorderSizePixel = 0
    scroll.ScrollBarThickness = 4
    scroll.ScrollBarImageColor3 = T.Accent
    scroll.CanvasSize = UDim2.new(0,0,0,0)
    scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    scroll.Parent = win

    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0,10)
    listLayout.Parent = scroll

    local pad = Instance.new("UIPadding")
    pad.PaddingTop = UDim.new(0,8)
    pad.PaddingBottom = UDim.new(0,12)
    pad.PaddingLeft = UDim.new(0,2)
    pad.PaddingRight = UDim.new(0,6)
    pad.Parent = scroll

    sg.Parent = CoreGui

    return {
        gui         = sg,
        win         = win,
        titleBar    = titleBar,
        scroll      = scroll,
        statusLbl   = statusLbl,
        statusDot   = statusDot,
        totalLbl    = totalLbl,
        serverLbl   = serverLbl,
        refreshLbl  = refreshLbl,
        closeBtn    = closeBtn,
        minimizeBtn = minimizeBtn,
    }
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  SERVER PANEL  (with dropdown)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function buildServerPanel(serverId, brainrots, placeId, parent)
    table.sort(brainrots, function(a,b) return (a.income or 0)>(b.income or 0) end)

    local isCurrentServer = (serverId == game.JobId)
    local shortId = serverId:sub(1,18).."â€¦"
    
    -- Get player count from first brainrot (they all share same server)
    local playerCount = brainrots[1] and brainrots[1].playerCount or 0
    
        -- Check if server should be highlighted (contains high income brainrot 500M+)
    local isHighlighted = false
    for _, br in ipairs(brainrots) do
        if br.income and br.income >= HIGH_INCOME_THRESHOLD then
            isHighlighted = true
            break
        end
    end
    
    -- Gold color for highlighted servers
    local goldColor = Color3.fromRGB(255, 215, 0)

    -- Outer wrapper â€” auto-sizes
    local wrapper = Instance.new("Frame")
    wrapper.Size = UDim2.new(1,-4,0,0)
    wrapper.AutomaticSize = Enum.AutomaticSize.Y
    wrapper.BackgroundTransparency = 1
    wrapper.BorderSizePixel = 0
    wrapper.Parent = parent

        -- Panel card
    local panel = Instance.new("Frame")
    panel.Size = UDim2.new(1,0,0,0)
    panel.AutomaticSize = Enum.AutomaticSize.Y
    panel.BackgroundColor3 = T.Panel
    panel.BorderSizePixel = 0
    panel.Parent = wrapper
    corner(panel, 6)
    
    -- Apply gold border for highlighted servers
    if isHighlighted then
        stroke(panel, goldColor, 2, 0)
    else
        stroke(panel, isCurrentServer and T.Accent or T.Border, 1, isCurrentServer and 0.3 or 0.0)
    end

    local panelLayout = Instance.new("UIListLayout")
    panelLayout.SortOrder = Enum.SortOrder.LayoutOrder
    panelLayout.Padding = UDim.new(0,0)
    panelLayout.Parent = panel

        -- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local header = Instance.new("TextButton")
    header.Name = "Header"
    header.Size = UDim2.new(1,0,0,44)
    header.BackgroundColor3 = isHighlighted and Color3.fromRGB(60, 55, 40) or T.Card
    header.BorderSizePixel = 0
    header.Text = ""
    header.AutoButtonColor = false
    header.LayoutOrder = 1
    header.Parent = panel
    corner(header, 6)

    -- Accent left border stripe (gold if highlighted)
    local stripeColor = isHighlighted and goldColor or (isCurrentServer and T.Accent or T.Blue)
    local stripe = frame(header, {sz=UDim2.new(0,4,0,28), pos=UDim2.new(0,10,0,8), bg=stripeColor})
    corner(stripe, 2)
    
    -- Add gold glow effect for highlighted servers
    if isHighlighted then
        local glow = Instance.new("UIGradient")
        glow.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, goldColor),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 235, 100)),
            ColorSequenceKeypoint.new(1, goldColor),
        })
        glow.Rotation = 90
        glow.Parent = stripe
    end

            -- Server ID with gold star if highlighted
    local serverIdText = isHighlighted and "â­ "..shortId or shortId
    local serverIdLbl = label(header, {
        text=serverIdText, size=13, color=isHighlighted and goldColor or T.Text, font=Enum.Font.Code,
        sz=UDim2.new(1,-340,1,0), pos=UDim2.new(0,22,0,0),
        align=Enum.TextXAlignment.Left, truncate=true
    })
    if isHighlighted then
        serverIdLbl.TextStrokeTransparency = 0.7
        serverIdLbl.TextStrokeColor3 = Color3.fromRGB(100, 80, 0)
    end
    
    -- Player count badge
    local playerBadge = frame(header, {sz=UDim2.new(0,70,0,22), pos=UDim2.new(1,-308,0,11), bg=T.Bg})
    corner(playerBadge, 11)
    stroke(playerBadge, T.Border, 1, 0)
    label(playerBadge, {
        text="ğŸ‘¥ "..playerCount, size=10, color=T.Accent, font=Enum.Font.Code,
        align=Enum.TextXAlignment.Center
    })

        -- Found count badge
    local countBadge = frame(header, {sz=UDim2.new(0,64,0,22), pos=UDim2.new(1,-228,0,11), bg=T.Bg})
    corner(countBadge, 11)
    stroke(countBadge, T.Border, 1, 0)
    label(countBadge, {
        text=#brainrots.." FOUND", size=10, color=T.Green, font=Enum.Font.Code,
        align=Enum.TextXAlignment.Center
    })

        -- Join / Current badge
    if isCurrentServer then
        local badge = frame(header, {sz=UDim2.new(0,90,0,24), pos=UDim2.new(1,-155,0,10), bg=T.Bg})
        corner(badge, 4)
        stroke(badge, T.Accent, 1, 0.2)
        label(badge, {
            text="â— THIS SERVER", size=10, color=T.Accent, font=Enum.Font.Code,
            align=Enum.TextXAlignment.Center
        })
    else
        local joinBtn = Instance.new("TextButton")
        joinBtn.Size = UDim2.new(0,80,0,26)
        joinBtn.Position = UDim2.new(1,-158,0,9)
        joinBtn.BackgroundColor3 = T.AccentDim
        joinBtn.Text = "JOIN â†’"
        joinBtn.TextColor3 = T.Text
        joinBtn.TextSize = 11
        joinBtn.Font = Enum.Font.Code
        joinBtn.BorderSizePixel = 0
        joinBtn.AutoButtonColor = false
        joinBtn.Parent = header
        corner(joinBtn, 4)
        joinBtn.MouseEnter:Connect(function() joinBtn.BackgroundColor3 = T.Accent end)
        joinBtn.MouseLeave:Connect(function() joinBtn.BackgroundColor3 = T.AccentDim end)
        joinBtn.MouseButton1Click:Connect(function()
            joinBtn.Text = "..."
            pcall(function()
                TeleportService:TeleportToPlaceInstance(placeId, serverId, Players.LocalPlayer)
            end)
        end)
    end

    -- Dropdown chevron button
    local isOpen = true
    local chevron = label(header, {
        text="â–¾", size=16, color=T.TextDim, font=Enum.Font.Code,
        sz=UDim2.new(0,28,1,0), pos=UDim2.new(1,-34,0,0),
        align=Enum.TextXAlignment.Center
    })

    -- â”€â”€ Body (brainrot list) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local body = Instance.new("Frame")
    body.Name = "Body"
    body.Size = UDim2.new(1,0,0,0)
    body.AutomaticSize = Enum.AutomaticSize.Y
    body.BackgroundTransparency = 1
    body.BorderSizePixel = 0
    body.LayoutOrder = 2
    body.ClipsDescendants = true
    body.Parent = panel

    local bodyPad = Instance.new("UIPadding")
    bodyPad.PaddingLeft  = UDim.new(0,10)
    bodyPad.PaddingRight = UDim.new(0,10)
    bodyPad.PaddingTop   = UDim.new(0,8)
    bodyPad.PaddingBottom= UDim.new(0,10)
    bodyPad.Parent = body

    local bodyLayout = Instance.new("UIListLayout")
    bodyLayout.SortOrder = Enum.SortOrder.LayoutOrder
    bodyLayout.Padding = UDim.new(0,6)
    bodyLayout.Parent = body

        -- â”€â”€ Brainrot rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for i, br in ipairs(brainrots) do
        local rarityColor = RARITY[br.rarity] or RARITY["Unknown"]
        local isRainbow = (rarityColor == "rainbow")

        local row = Instance.new("Frame")
        row.Size = UDim2.new(1,0,0,66)
        row.BackgroundColor3 = T.Bg
        row.BorderSizePixel = 0
        row.LayoutOrder = i
        row.Parent = body
        corner(row, 5)
        stroke(row, T.Border, 1, 0)

                -- Left rarity accent
        local rac = frame(row, {sz=UDim2.new(0,3,0,50), pos=UDim2.new(0,8,0,8), bg=isRainbow and Color3.fromRGB(255,0,0) or rarityColor})
        corner(rac, 2)
        if isRainbow then
            local rainbowGrad = Instance.new("UIGradient")
            rainbowGrad.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0.0, Color3.fromRGB(255, 0, 0)),
                ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 127, 0)),
                ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255, 255, 0)),
                ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 0)),
                ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
                ColorSequenceKeypoint.new(0.83, Color3.fromRGB(75, 0, 130)),
                ColorSequenceKeypoint.new(1.0, Color3.fromRGB(148, 0, 211)),
            })
            rainbowGrad.Rotation = 90
            rainbowGrad.Parent = rac
        end

        -- Name
        label(row, {
            text=br.name, size=13, color=T.Text, font=Enum.Font.Code,
            sz=UDim2.new(1,-175,0,18), pos=UDim2.new(0,20,0,8),
            align=Enum.TextXAlignment.Left, truncate=true
        })

                -- Time ago (color-coded by age)
        label(row, {
            text=timeAgo(br.foundAt).." ago", size=10, color=getTimeColor(br.foundAt), font=Enum.Font.Code,
            sz=UDim2.new(0,70,0,14), pos=UDim2.new(1,-150,0,10),
            align=Enum.TextXAlignment.Right
        })

                -- Rarity badge
        local rb = frame(row, {sz=UDim2.new(0,56,0,18), pos=UDim2.new(1,-70,0,8), bg=isRainbow and Color3.fromRGB(255,0,0) or T.Bg})
        corner(rb, 9)
        if isRainbow then
            local rainbowGrad = Instance.new("UIGradient")
            rainbowGrad.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0.0, Color3.fromRGB(255, 0, 0)),
                ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 127, 0)),
                ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255, 255, 0)),
                ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 0)),
                ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
                ColorSequenceKeypoint.new(0.83, Color3.fromRGB(75, 0, 130)),
                ColorSequenceKeypoint.new(1.0, Color3.fromRGB(148, 0, 211)),
            })
            rainbowGrad.Parent = rb
            stroke(rb, Color3.fromRGB(255, 0, 0), 1, 0)
        else
            stroke(rb, rarityColor, 1, 0)
        end
        local rarityLbl = label(rb, {
            text=br.rarity, size=10, color=isRainbow and Color3.fromRGB(255,255,255) or rarityColor, font=Enum.Font.Code,
            align=Enum.TextXAlignment.Center
        })
        if isRainbow then
            rarityLbl.TextStrokeTransparency = 0.5
            rarityLbl.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
        end

        -- Stat line: income | cost | mutation | traits
        local statRow = Instance.new("Frame")
        statRow.Size = UDim2.new(1,-20,0,16)
        statRow.Position = UDim2.new(0,20,0,30)
        statRow.BackgroundTransparency = 1
        statRow.Parent = row

        local statLayout = Instance.new("UIListLayout")
        statLayout.FillDirection = Enum.FillDirection.Horizontal
        statLayout.VerticalAlignment = Enum.VerticalAlignment.Center
        statLayout.Padding = UDim.new(0,0)
        statLayout.Parent = statRow

        local function statItem(icon, val, color, w)
            local s = frame(statRow, {sz=UDim2.new(0,w,1,0), bg=T.Transparent})
            s.BackgroundTransparency = 1
            label(s, {
                text=icon.." "..val, size=11, color=color, font=Enum.Font.Code,
                align=Enum.TextXAlignment.Left
            })
        end
        statItem("$", short(br.income).."/s", T.Green, 110)
        statItem("Â¢", short(br.cost),          T.Yellow, 100)

        -- Details line
        label(row, {
            text="â—ˆ "..( br.mutation or "â€”" ).."   â— "..( br.traits or "â€”" ),
            size=10, color=T.TextDim, font=Enum.Font.Code,
            sz=UDim2.new(1,-20,0,14), pos=UDim2.new(0,20,0,50),
            align=Enum.TextXAlignment.Left, truncate=true
        })
    end

    -- â”€â”€ Dropdown toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    local function setOpen(open)
        isOpen = open
        body.Visible = open
        chevron.Text = open and "â–¾" or "â–¸"
        chevron.TextColor3 = open and T.TextMid or T.TextDim
    end

        header.MouseButton1Click:Connect(function()
        setOpen(not isOpen)
    end)
    header.MouseEnter:Connect(function()
        header.BackgroundColor3 = isHighlighted and Color3.fromRGB(70, 60, 45) or T.CardHover
    end)
    header.MouseLeave:Connect(function()
        header.BackgroundColor3 = isHighlighted and Color3.fromRGB(60, 55, 40) or T.Card
    end)

    return wrapper
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  UPDATE GUI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function updateGUI(ui, data)
    if not data then
        ui.statusDot.TextColor3 = T.Red
        ui.statusLbl.Text = "ERROR"
        return
    end

    ui.statusDot.TextColor3 = T.Green
    ui.statusLbl.Text = "SYNCED "..timeAgo(data.timestamp).." AGO"
    ui.refreshLbl.Text = "SYNCED: "..timeAgo(data.timestamp)

    -- Clear old panels
    for _, ch in ipairs(ui.scroll:GetChildren()) do
        if ch:IsA("Frame") then ch:Destroy() end
    end

    -- Group by server
    local groups = {}
    for _, br in ipairs(data.brainrots or {}) do
        local sid = br.serverId or "unknown"
        groups[sid] = groups[sid] or {}
        table.insert(groups[sid], br)
    end

    local total = #(data.brainrots or {})
    local serverCount = 0
    for _ in pairs(groups) do serverCount = serverCount + 1 end

    ui.totalLbl.Text  = "BRAINROTS: "..total
    ui.serverLbl.Text = "SERVERS: "..serverCount

    -- Sort servers newest first
    local sorted = {}
    for sid, brs in pairs(groups) do
        local t = 0
        for _, b in ipairs(brs) do if b.foundAt > t then t = b.foundAt end end
        table.insert(sorted, {id=sid, brs=brs, latest=t})
    end
    table.sort(sorted, function(a,b) return a.latest > b.latest end)

    for _, s in ipairs(sorted) do
        buildServerPanel(s.id, s.brs, data.placeId, ui.scroll)
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--  MAIN
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function main()
    local ui = buildGUI()

    -- Close
    ui.closeBtn.MouseButton1Click:Connect(function()
        ui.gui:Destroy()
    end)

    -- Minimize toggle
    local minimized = false
    local fullHeight = 640
    ui.minimizeBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            ui.win.Size = UDim2.new(0, 760, 0, 42)
            ui.scroll.Visible = false
        else
            ui.win.Size = UDim2.new(0, 760, 0, fullHeight)
            ui.scroll.Visible = true
        end
        ui.minimizeBtn.Text = minimized and "â–¡" or "â€”"
    end)

    -- Stat bar hides when minimized (part of scroll area already handled)

        -- Fetch + display
    local data = fetchGistData()
    if data then
        lastKnownTimestamp = data.timestamp
        updateGUI(ui, data)
    end

    -- Fast refresh loop with timestamp checking
    task.spawn(function()
        while ui.gui.Parent do
            task.wait(REFRESH_INTERVAL)
            data = fetchGistData()
            if ui.gui.Parent and data then
                -- Only update UI if data actually changed
                if data.timestamp ~= lastKnownTimestamp then
                    lastKnownTimestamp = data.timestamp
                    updateGUI(ui, data)
                    print("[Viewer] ğŸ”„ Synced new data from Gist")
                end
            end
        end
    end)

    -- Draggable via title bar
    local dragging, dragStart, winStart
    ui.titleBar.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = inp.Position
            winStart  = ui.win.Position
            inp.Changed:Connect(function()
                if inp.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    local lastDragInput
    ui.titleBar.InputChanged:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseMovement then
            lastDragInput = inp
        end
    end)
    UserInputService.InputChanged:Connect(function(inp)
        if inp == lastDragInput and dragging then
            local delta = inp.Position - dragStart
            ui.win.Position = UDim2.new(
                winStart.X.Scale, winStart.X.Offset + delta.X,
                winStart.Y.Scale, winStart.Y.Offset + delta.Y
            )
        end
    end)
end

main()
